<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Document</title>
  </head>
  <body>
    <header class="container">
    <div class="logo"><a href="index.html">Notesapp</a></div>
    <nav>
      <div class="navbar-links" id="navbarLinks">
      </div>
    </nav>
  </header>
    <div class="signup-container">
      <form class="signup-form" id="signupForm" novalidate>
        <h2>Sign Up</h2>

        <label for="name">Name</label>
        <input
          type="text"
          id="name"
          name="name"
          placeholder="Your full name"
          required
          minlength="3"
        />

        <label for="email">Email</label>
        <input
          type="email"
          id="email"
          name="email"
          placeholder="you@example.com"
          required
        />

        <label for="password">Password</label>
        <input
          type="password"
          id="password"
          name="password"
          placeholder="Create a password"
          required
          minlength="6"
        />

        <button id="signupbtn" style="display: flex; align-items: center; justify-content: center;" type="submit">
            Sign Up
        </button>

        <div class="signin-link">
          Already have an account? <a href="#">Sign In</a>
        </div>
      </form>

      <br />

      <form class="otp-form" id="otpForm" autocomplete="off" novalidate>
        <h2>Verify Your Email</h2>
        <p>Please enter the 6-digit OTP sent to your email address.</p>

        <input
          type="text"   
          id="otp"
          name="otp"
          maxlength="6"
          placeholder="Enter OTP"
          required
          pattern="\d{6}"
        />

        <button type="submit">Verify</button>

        <p class="resend-text">
          Didn't receive the code? <a href="#" id="resendOtp">Resend OTP</a>
        </p>


      </form>
    </div>

    <script>
      document.getElementById("otpForm").style.display = "none"; // Hide OTP form initially

      document
        .getElementById("signupForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const nameInput = form.name;
          const emailInput = form.email;
          const passwordInput = form.password;
          const name = nameInput.value.trim();
          const email = emailInput.value.trim();
          const password = passwordInput.value;

          if (name.length < 3) {
            alert("Name must be at least 3 characters long.");
            nameInput.focus();
            return;
          }

          if (!emailInput.validity.valid) {
            alert("Please enter a valid email address.");
            emailInput.focus();
            return;
          }

          if (password.length < 6) {
            alert("Password must be at least 6 characters.");
            passwordInput.focus();
            return;
          }

          
          try {
            document.getElementById("signupbtn").innerHTML = `<div class="loader"></div>`
            const response = await fetch(
              "http://localhost:3000/api/v1/auth/signup",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, email, password }),
                credentials: "include",
              }
            );


            const data = await response.json();
            
            if (response.ok && data.success) {
              alert("Signup successful! Please verify your email.");
              document.getElementById("otpForm").style.display = "block"; // Show OTP form
              form.style.display = "none"; // Optionally hide signup form
            } else {
              alert(data.message || "Signup failed.");
            }
          } catch (error) {
            alert("Error signing up: " + error.message);
          }
        });

      document
        .getElementById("otpForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          

          const email = document.getElementById("email").value.trim();
          console.log(email)
          const otpInput = e.target.otp;
          const otp = otpInput.value.trim();
          console.log("otp entered " + otp);

          if (!/^\d{6}$/.test(otp)) {
            alert("Please enter a valid 6-digit OTP.");
            otpInput.focus();
            return;
          }
          console.log("otp valid " + otp);


          try {
            const response = await fetch(
              "http://localhost:3000/api/v1/auth/verifyEmail",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ verificationCode: otp, email }),
                credentials: "include",
              }
            );

            
            const data = await response.json();

            if (response.ok && data.success) {
              alert("Email verified successfully!");
              window.location.href = 'http://localhost:5173/signin.html';

            } else {
              alert(data.message || "OTP verification failed.");
            }
          } catch (error) {
            alert("Error verifying OTP: " + error.message);
          }
        });

      // Resend OTP handler
      document.getElementById("resendOtp").addEventListener("click", (e) => {
        e.preventDefault();
        try {
            
        } catch (error) {
            
        }

        
        alert("OTP resent to your email!");
      });
    
    </script>
  <script src="src/nav.js"></script>

  </body>
</html>
