<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Note Details</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="container">
      <div class="logo"><a href="index.html">Notesapp</a></div>
      <nav>
        <div class="navbar-links" id="navbarLinks"></div>
      </nav>
    </header>
    <div class="note-details">
      <form id="noteForm">
        <h2 class="form-title">Edit Note</h2>
        <div class="form-group">
          <label for="title">Title</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            maxlength="100"
            placeholder="Enter title"
          />
        </div>
        <div class="form-group">
          <label for="content">Content</label>
          <textarea
            id="content"
            name="content"
            rows="8"
            required
            maxlength="5000"
            placeholder="Enter note content"
          ></textarea>
        </div>
        <div class="button-group">
          <button type="submit" class="btn update">Update</button>
          <button type="button" class="btn delete" id="deleteBtn">
            Delete
          </button>
        </div>
      </form>
      <div id="statusMessage"></div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const noteId = urlParams.get("id");

      const titleInput = document.getElementById("title");
      const contentInput = document.getElementById("content");
      const noteForm = document.getElementById("noteForm");
      const deleteBtn = document.getElementById("deleteBtn");
      const statusMessage = document.getElementById("statusMessage");

      if (!noteId) {
        statusMessage.textContent = "Invalid note ID.";
        noteForm.style.display = "none";
      } else {
        fetchNoteDetails(noteId);
      }

      async function fetchNoteDetails(id) {
        try {
          const res = await fetch(`http://localhost:3000/api/v1/notes/${id}`, {
            credentials: "include",
          });
          const data = await res.json();

          if (res.ok && data.success) {
            titleInput.value = data.note.title || "";
            contentInput.value = data.note.content || "";
          } else {
            statusMessage.textContent = data.message || "Failed to load note.";
            noteForm.style.display = "none";
          }
        } catch (error) {
          statusMessage.textContent = "Error fetching note details.";
          noteForm.style.display = "none";
        }
      }

      // Update note
      noteForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const updatedTitle = titleInput.value.trim();
        const updatedContent = contentInput.value.trim();

        if (!updatedTitle || !updatedContent) {
          statusMessage.textContent = "Title and Content cannot be empty.";
          return;
        }

        try {
          const res = await fetch(
            `http://localhost:3000/api/v1/notes/${noteId}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({
                title: updatedTitle,
                content: updatedContent,
              }),
            }
          );
          const data = await res.json();

          if (res.ok && data.success) {
            statusMessage.style.color = "green";
            statusMessage.textContent = "Note updated successfully!";
            window.location.href = "home.html"; // Redirect back to homepage
          } else {
            statusMessage.style.color = "red";
            statusMessage.textContent =
              data.message || "Failed to update note.";
          }
        } catch (error) {
          statusMessage.style.color = "red";
          statusMessage.textContent = "Error updating note.";
        }
      });

      // Delete note
      deleteBtn.addEventListener("click", async () => {
        if (
          !confirm(
            "Are you sure you want to delete this note? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          const res = await fetch(
            `http://localhost:3000/api/v1/notes/${noteId}`,
            {
              method: "DELETE",
              credentials: "include",
            }
          );
          const data = await res.json();

          if (res.ok && data.success) {
            alert("Note deleted successfully!");
            window.location.href = "home.html"; // Redirect back to homepage
          } else {
            statusMessage.style.color = "red";
            statusMessage.textContent =
              data.message || "Failed to delete note.";
          }
        } catch (error) {
          statusMessage.style.color = "red";
          statusMessage.textContent = "Error deleting note.";
        }
      });

    </script>
  <script src="src/nav.js"></script>

  </body>
</html>
